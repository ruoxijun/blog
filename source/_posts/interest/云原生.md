---
title: 云原生
date: 2023-04-02 10:04:00
categories: Linux
tags: 
    - linux
    - docker
    - kubernetes
    - k8s
---

# 云原生

## Docker

![docker.png](/images/linux/docker.png)

### 安装 docker

> centos 7 为例

1. 卸载旧版本以及关联的依赖项

```bash
yum remove docker \
        docker-client \
        docker-client-latest \
        docker-common \
        docker-latest \
        docker-latest-logrotate \
        docker-logrotate \
        docker-engine
```

2. 安装必要的软件包

```bash
yum install -y yum-utils device-mapper-persistent-data lvm2
```

3. 添加 Docker 的 GPG 密钥

```bash
yum-config-manager \
--add-repo \
http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
```

4. 安装最新版本的 Docker 引擎及其所有依赖项

```bash
yum install -y docker-ce \
            docker-ce-cli \
            containerd.io \
            docker-buildx-plugin \
            docker-compose-plugin
```

5. 启动 Docker 服务并设置开机自启动

```bash
# systemctl enable docker --now # 相当下面2个命令
systemctl start docker
systemctl enable docker
systemctl enable containerd
```

6. 配置镜像加速器

```bash
# 获取阿里云个人镜像加速地址 https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": [
    "https://cg6pt9r4.mirror.aliyuncs.com",
    "https://docker.mirrors.ustc.edu.cn",
    "https://registry.docker-cn.com",
    "http://hub-mirror.c.163.com"
  ],
  "exec-opts": ["native.cgroupdriver=systemd"],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m"
  },
  "storage-driver": "overlay2"
}
EOF
sudo systemctl daemon-reload
sudo systemctl restart docker
```

### 基础命令

* [Docker Hub 各类镜像地址 https://hub.docker.com/](https://hub.docker.com/)

#### 镜像管理：

```bash
# 拉取最新版镜像（nginx:latest 不写默认是 latest）
docker pull nginx
# 拉取指定版本镜像
docker pull nginx:1.20.1

# 查看所有本地镜像
docker images

# 删除镜像
docker rmi 镜像名:版本号/镜像id
```

#### 容器管理：

* `docker run` 创建并运行容器：

```bash
docker run --name mynginx -d --restart=always -p 88:80 nginx
# --name ：容器名称
# -d ：后台运行
# --restart=always： 开机自启
# -p 本机端口:容器端口： 端口映射（本机有多个 ip 时可指定）
# -p 8080-8090:8080-8090：映射一个端口范围，前后必须对应

docker run -it --rm --name my-mysql -e MYSQL_ROOT_PASSWORD=123456 \
-d mysql mysql -uroot -p
# -it：进入 Docker 容器的交互式终端,通常与 /bin/bash 或 /bin/sh 等 shell 命令一起使用
# --rm ：在容器退出时自动删除容器
# -e ：设置环境变量（这里设置 mysql 密码）
# 镜像名后跟着的命令，表示启动容器后会自动执行的命令

# 查看正在运行的容器
docker ps
# 查看所有
docker ps -a
# 查看所有停止的容器
docker ps -a -f status=exited
```

* 管理容器：

```bash
# 停止容器
docker stop 容器
# 停止所有容器
docker stop $(dokcer ps -aq)

# 启动容器
docker start 容器
# 重启容器
docker restart 容器

# 删除停止的容器
docker rm  容器
# 强制删除正在运行中的容器
docker rm -f 容器

# 动态地更新容器的配置
docker update 容器 --restart=always
```

* 容器信息：

```bash
# 查看日志（-f  跟踪日志）
docker logs 容器

# 查看容器 ip
docker inspect \
    --format='{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' 容器
```

### 交互方式

#### 交互模式：

```bash
# 连接并进入正在运行的 Docker 容器的交互式终端
docker exec -it 容器 /bin/bash

# 用一个 mysql 容器进入交互模式控制另一个 mysql 容器,并在退出容器时删除
docker run -it --rm mysql:5.7 mysql -h容器ip -uroot -p

# 退出交互模式
exit
```

#### 挂载数据：

```bash
# 将主机的 /data/html 挂载到容器 /usr/share/nginx/html 中
docker run --name=mynginx -d -p 88:80 \
-v /data/html:/usr/share/nginx/html:ro nginx
# ro 只读，rw 可读写（默认）
```

#### 数据拷贝：

```bash
# 将 容器 内文件复制至 主机 中
docker cp 容器:/etc/nginx/nginx.conf /data/conf/nginx.conf
# 将 主机 中文件复制至 容器 内
docker cp /data/conf/nginx.conf 容器:/etc/nginx/nginx.conf
```

#### 自定义网络：

```bash
# 创建用户自定义网络
docker network create my-net

# 将已有容器连接到此网络
docker network connect my-net db-mysql
# 创建容器时指定网络（容器之间可以通过容器名进行访问）
docker run -it --rm --network my-net mysql:5.7 mysql -hdb-mysql -uroot -p
```

### 镜像制作与保存

#### 生成镜像：

```bash
# 将一个 容器 保存为一个新的镜像
docker commit -a "作者" -m "信息" 容器名/id 新镜像名[:版本]
```

#### tar 保存镜像：

```bash
# 将 镜像 保存成压缩包
docker save -o 压缩包名.tar 镜像名[:版本]/id
# 通过压缩包加载 镜像
docker load -i 压缩包名.tar
```

#### 镜像推送：

1. 为本地的一个镜像添加一个新的标签：

```bash
# 注意这个标签名应为你要上传的仓库的 命名空间/厂库名
docker tag 镜像[:版本]/id 新镜像名即标签名[:版本]
docker tag mynginx:1.0 ruoxijun/main:v1.0
```

2. 登录并推送到云端仓库：

```bash
# 登录到 DockerHub
docker login
# 登录阿里云镜像仓库
docker login --username=ruoxijun registry.cn-chengdu.aliyuncs.com

# 推送
docker push 镜像名即标签名[:版本]
docker push ruoxijun/main:v1.0

# 推送完镜像后建议退出
docker logout
```

3. 拉取镜像

```bash
# 拉取上传的镜像（私有镜像需要登录后才能拉取）
docker pull ruoxijun/main:v1.0
```

### Dockerfile



```bash
# 创建一个名为 Dockerfile 的文件内容如下：
FROM openjdk:8-jdk-slim                 # 使用 openjdk:8-jdk-slim 镜像作为基础镜像
LABEL maintainer=leifengyang            # 作者
COPY target/*.jar /app.jar              # target 下所有 .jar 文件复制到容器中的 / 目录下，改为 app.jar
ENTRYPOINT ["java","-jar","/app.jar"]   # 容器启动后运行特定命令
```



```bash
# 从 Dockerfile 构建镜像
docker build -t java-demo:v1.0 .
# 指定文件构建镜像
docker build -f /path/to/a/Dockerfile -t <image-name>:<tag> .
```



### docker-compose



```bash
# 基本操作
docker-compose up -d
# 关闭并删除容器
docker-compose down
# 开启|关闭|重启已经存在的由 docker-compose 维护的容器
docker-compose start|stop|restart
# 运行当前内容，并重新构建
docker-compose up -d --build
```







































